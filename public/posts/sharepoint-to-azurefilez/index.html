<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Copy sharepoint data to Azure Filez" />
<meta property="og:locale" content="en" />
<meta name="description" content="Summary: This PowerShell script copies files and folders from a SharePoint site into an Azure Files share. It supports a -DryRun mode to preview the operations without making changes. The script enumerates folders and files in SharePoint, creates matching directories in Azure Files, downloads files into a temporary location, uploads them into the Azure Files share, and keeps simple statistics about folders and files processed." />
<meta property="og:description" content="Summary: This PowerShell script copies files and folders from a SharePoint site into an Azure Files share. It supports a -DryRun mode to preview the operations without making changes. The script enumerates folders and files in SharePoint, creates matching directories in Azure Files, downloads files into a temporary location, uploads them into the Azure Files share, and keeps simple statistics about folders and files processed." />
<link rel="canonical" href="https://lubenz007.github.io//posts/sharepoint-to-azurefilez/" />
<meta property="og:url" content="https://lubenz007.github.io//posts/sharepoint-to-azurefilez/" />
<meta property="og:site_name" content="BensiEgils" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-12-23T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Copy sharepoint data to Azure Filez" />
<meta name="twitter:site" content="@lubenz007" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-12-23T00:00:00+00:00","datePublished":"2025-12-23T00:00:00+00:00","description":"Summary: This PowerShell script copies files and folders from a SharePoint site into an Azure Files share. It supports a -DryRun mode to preview the operations without making changes. The script enumerates folders and files in SharePoint, creates matching directories in Azure Files, downloads files into a temporary location, uploads them into the Azure Files share, and keeps simple statistics about folders and files processed.","headline":"Copy sharepoint data to Azure Filez","mainEntityOfPage":{"@type":"WebPage","@id":"https://lubenz007.github.io//posts/sharepoint-to-azurefilez/"},"url":"https://lubenz007.github.io//posts/sharepoint-to-azurefilez/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Copy sharepoint data to Azure Filez | BensiEgils
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">



  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="https://bensiegils.com/assets/img/logo/BensiLogo.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">BensiEgils</a>
    <p class="site-subtitle fst-italic mb-0">Documenting my journey</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tag"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    

      
        <a
          href="https://github.com/lubenz007"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    

      
        <a
          href="https://twitter.com/lubenz007"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-twitter"></i>
        </a>
      
    

      
        <a
          href="javascript:location.href = 'mailto:' + ['bensi','alit.is'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
          
      

      
        <a
          href="https://www.linkedin.com/in/benedikt-gabríel-egilsson-b7295684"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>Copy sharepoint data to Azure Filez</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  

  
  

  

  
  

  

  
  

  




<!-- return -->










<article class="px-1" data-toc="false">
  <header>
    <h1 data-toc-skip>Copy sharepoint data to Azure Filez</h1>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1766448000"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Dec 23, 2025
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://twitter.com/lubenz007">Benedikt Gabriel Egilsson</a>
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="1584 words"
>
  <em>8 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  

  <div class="content">
    <p><strong>Summary:</strong> This PowerShell script copies files and folders from a SharePoint site into an Azure Files share. It supports a <code class="language-plaintext highlighter-rouge">-DryRun</code> mode to preview the operations without making changes. The script enumerates folders and files in SharePoint, creates matching directories in Azure Files, downloads files into a temporary location, uploads them into the Azure Files share, and keeps simple statistics about folders and files processed.</p>

<p><strong>Flow diagram:</strong></p>

<pre><code class="language-mermaid">flowchart TD
  A[Start] --&gt; B{DryRun?}
  B -- Yes --&gt; C[Scan SharePoint folders &amp; list operations]
  B -- No --&gt; D[Connect to SharePoint]
  D --&gt; E[Enumerate files &amp; folders]
  E --&gt; F{Item Type}
  F -- File --&gt; G[Download file -&gt; Upload to Azure Files]
  F -- Folder --&gt; H[Ensure Azure Files dir exists -&gt; Recurse]
  G --&gt; I[Update stats]
  H --&gt; E
  C --&gt; I
  I --&gt; J[Finish &amp; Report]
</code></pre>

<script>
// Inline helper to convert code blocks with 'language-mermaid' into div.mermaid
document.addEventListener('DOMContentLoaded', function(){
  try{
    document.querySelectorAll('pre > code.language-mermaid, pre > code[data-lang="mermaid"]').forEach(function(code){
      var pre = code.parentElement;
      var div = document.createElement('div');
      div.className = 'mermaid';
      div.textContent = code.textContent;
      pre.parentNode.replaceChild(div, pre);
    });
    if(window.mermaid && typeof window.mermaid.init === 'function'){
      try{ window.mermaid.init(); } catch(e){ console.warn('mermaid init failed', e); }
    }
  }catch(e){ console.warn('mermaid helper failed', e); }
});
</script>

<p>&lt;#
.SYNOPSIS
    Copy files from SharePoint site to Azure Files with automatic folder creation
.PARAMETER DryRun
    When specified, the script will only list what would be copied without actually copying anything
.EXAMPLE
    .\Copy-SharePoint-to-AzureFiles.ps1 -DryRun
    Run in dry run mode to preview all operations
.EXAMPLE
    .\Copy-SharePoint-to-AzureFiles.ps1
    Execute the actual copy operation
#&gt;</p>

<p>param(
    [switch]$DryRun
)</p>

<h1 id="global-statistics">Global statistics</h1>
<p>$script:Stats = @{
    FoldersToCreate = 0
    FilesToCopy = 0
    TotalSize = 0
    FoldersList = @()
    FilesList = @()
}</p>

<h1 id="configuration---sharepoint-source">Configuration - SharePoint Source</h1>
<p>$SourceSiteUrl = “https://xxxx.sharepoint.com/sites/xxxx”
$ClientId = “xxxxxxxx-xxxxx-xxxx”
$UseInteractiveLogin = $true # Set to $true to use Interactive login (recommended for Global Admin)
$SourceLibrary = “” # Empty - folders are at site root level
$SourceRootFolder = “” # Empty because the site URL already points to folder_structure
$SubFolders = @(“xxxxx”, “xxxxx”, “xxxx”, “xxxxx”, “xxxxx”)</p>

<h1 id="configuration---azure-files-destination">Configuration - Azure Files Destination</h1>
<p>$StorageAccountName = “xx”  # Change this
$FileShareName = “xx”            # Change this
$StorageAccountKey = “xxx”     # Change this or use connection string
$DestinationRootFolder = “xxxxx” # Root folder in Azure Files</p>

<h1 id="temporary-download-location">Temporary download location</h1>
<p>$TempDownloadPath = “$env:TEMP\SharePointToAzureFiles”</p>

<h1 id="function-to-ensure-azure-files-directory-exists">Function to ensure Azure Files directory exists</h1>
<p>function Initialize-AzureFilesDirectory {
    param(
        [Parameter(Mandatory = $true)]
        [string]$DirectoryPath,
        [Parameter(Mandatory = $true)]
        $Context,
        [switch]$DryRun
    )</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre>if ($DryRun) {
    Write-Host "[DRY RUN] Would check/create directory: $DirectoryPath" -ForegroundColor Cyan
    return
}

$pathParts = $DirectoryPath.Trim('/').Split('/')
$currentPath = ""

foreach ($part in $pathParts) {
    if ($currentPath -eq "") {
        $currentPath = $part
    } else {
        $currentPath = "$currentPath/$part"
    }
    
    # Check if directory exists
    $dir = Get-AzStorageFile -ShareName $FileShareName -Path $currentPath -Context $Context -ErrorAction SilentlyContinue
    
    if ($null -eq $dir) {
        Write-Host "Creating directory: $currentPath" -ForegroundColor Yellow
        try {
            $parentPath = if ($currentPath.Contains('/')) {
                $currentPath.Substring(0, $currentPath.LastIndexOf('/'))
            } else {
                $null
            }
            
            if ($parentPath) {
                New-AzStorageDirectory -ShareName $FileShareName -Path $currentPath -Context $Context -ErrorAction Stop | Out-Null
            } else {
                New-AzStorageDirectory -ShareName $FileShareName -Path $part -Context $Context -ErrorAction Stop | Out-Null
            }
            
            Write-Host "Created directory: $currentPath" -ForegroundColor Green
        }
        catch {
            Write-Host "Error creating directory $currentPath : $_" -ForegroundColor Red
        }
    }
} }
</pre></td></tr></tbody></table></code></div></div>

<h1 id="function-to-download-and-upload-files-recursively">Function to download and upload files recursively</h1>
<p>function Copy-FilesRecursively {
    param(
        [Parameter(Mandatory = $true)]
        [string]$SourcePath,
        [Parameter(Mandatory = $true)]
        [string]$DestinationPath,
        [Parameter(Mandatory = $false)]
        $AzureContext,
        [switch]$DryRun
    )</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre></td><td class="rouge-code"><pre>if ($DryRun) {
    Write-Host "`n[DRY RUN] Scanning folder: $SourcePath" -ForegroundColor Magenta
} else {
    Write-Host "`nProcessing folder: $SourcePath" -ForegroundColor Magenta
}

# Debug: Show the exact path being accessed
$fullPath = if ($SourceLibrary -eq "") { $SourcePath } else { "$SourceLibrary/$SourcePath" }
Write-Host "Debug: Attempting to access: $fullPath" -ForegroundColor Gray

# Get all items in the current folder from SharePoint
try {
    if ($SourceLibrary -eq "") {
        $items = Get-PnPFolderItem -FolderSiteRelativeUrl $SourcePath -ItemType All -ErrorAction Stop
    } else {
        $items = Get-PnPFolderItem -FolderSiteRelativeUrl "$SourceLibrary/$SourcePath" -ItemType All -ErrorAction Stop
    }
}
catch {
    Write-Host "Error accessing folder $SourcePath : $($_.Exception.Message)" -ForegroundColor Red
    return
}

if ($null -eq $items) {
    Write-Host "No items found in: $SourcePath" -ForegroundColor Yellow
    return
}

# Process files
foreach ($file in $items | Where-Object { $_.GetType().Name -eq "File" }) {
    $fileSize = [math]::Round($file.Length / 1MB, 2)
    
    if ($DryRun) {
        Write-Host "[DRY RUN] Would copy file: $($file.Name) (Size: $fileSize MB)" -ForegroundColor White
        $script:Stats.FilesToCopy++
        $script:Stats.TotalSize += $file.Length
        $script:Stats.FilesList += [PSCustomObject]@{
            Name = $file.Name
            Source = "$SourcePath/$($file.Name)"
            Destination = "$DestinationPath/$($file.Name)"
            Size = $fileSize
        }
    } else {
        Write-Host "Copying file: $($file.Name) (Size: $fileSize MB)" -ForegroundColor White
        
        try {
            # Download file from SharePoint to temp location
            $tempFilePath = Join-Path $TempDownloadPath $file.Name
            $fileUrl = if ($SourceLibrary -eq "") { "$SourcePath/$($file.Name)" } else { "$SourceLibrary/$SourcePath/$($file.Name)" }
            Get-PnPFile -Url $fileUrl -AsFile -Path $TempDownloadPath -Filename $file.Name -Force -ErrorAction Stop | Out-Null
            
            # Upload to Azure Files
            Set-AzStorageFileContent -ShareName $FileShareName -Source $tempFilePath -Path "$DestinationPath/$($file.Name)" -Context $AzureContext -Force -ErrorAction Stop | Out-Null
            
            # Clean up temp file
            Remove-Item $tempFilePath -Force -ErrorAction SilentlyContinue
            
            Write-Host "Successfully copied: $($file.Name)" -ForegroundColor Green
        }
        catch {
            Write-Host "Error copying file $($file.Name): $_" -ForegroundColor Red
        }
    }
}

# Process subfolders recursively
foreach ($folder in $items | Where-Object { $_.GetType().Name -eq "Folder" }) {
    $newSourcePath = "$SourcePath/$($folder.Name)"
    $newDestinationPath = "$DestinationPath/$($folder.Name)"
    
    if (-not $DryRun) {
        # Ensure Azure Files directory exists
        Initialize-AzureFilesDirectory -DirectoryPath $newDestinationPath -Context $AzureContext
    } else {
        $script:Stats.FoldersToCreate++
        if ($newDestinationPath -notin $script:Stats.FoldersList) {
            $script:Stats.FoldersList += $newDestinationPath
        }
    }
    
    Copy-FilesRecursively -SourcePath $newSourcePath -DestinationPath $newDestinationPath -AzureContext $AzureContext -DryRun:$DryRun
} }
</pre></td></tr></tbody></table></code></div></div>

<h1 id="main-script-execution">Main script execution</h1>
<p>try {
    if ($DryRun) {
        Write-Host “<code class="language-plaintext highlighter-rouge">n========================================" -ForegroundColor Yellow
        Write-Host "DRY RUN MODE - No changes will be made" -ForegroundColor Yellow
        Write-Host "========================================</code>n” -ForegroundColor Yellow
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
</pre></td><td class="rouge-code"><pre>Write-Host "Starting copy process..." -ForegroundColor Cyan
Write-Host "Source: $SourceSiteUrl" -ForegroundColor Cyan
Write-Host "Destination: Azure Files - $StorageAccountName/$FileShareName" -ForegroundColor Cyan

# Connect to SharePoint
Write-Host "`nConnecting to SharePoint source site..." -ForegroundColor Yellow
Write-Host "A browser window will open for authentication..." -ForegroundColor Cyan
try {
    if ($UseInteractiveLogin) {
        # Use Interactive login (browser-based authentication)
        Connect-PnPOnline -Url $SourceSiteUrl -ClientId $ClientId -ErrorAction Stop
    } else {
        Connect-PnPOnline -Url $SourceSiteUrl -ClientId $ClientId -ErrorAction Stop
    }
    Write-Host "Connected to SharePoint successfully" -ForegroundColor Green
}
catch {
    Write-Host "Failed to connect to SharePoint: $($_.Exception.Message)" -ForegroundColor Red
    Write-Host "Make sure pop-ups are allowed in your browser" -ForegroundColor Yellow
    throw
}

# Connect to Azure Storage (only for actual copy, not dry run)
if (-not $DryRun) {
    Write-Host "`nConnecting to Azure Storage..." -ForegroundColor Yellow
    $azureContext = New-AzStorageContext -StorageAccountName $StorageAccountName -StorageAccountKey $StorageAccountKey
    Write-Host "Connected to Azure Storage successfully" -ForegroundColor Green
    
    # Ensure temp download directory exists
    if (-not (Test-Path $TempDownloadPath)) {
        New-Item -ItemType Directory -Path $TempDownloadPath -Force | Out-Null
    }
} else {
    $azureContext = $null
}

# Process each subfolder
foreach ($subFolder in $SubFolders) {
    Write-Host "`n========================================" -ForegroundColor Cyan
    Write-Host "Processing subfolder: $subFolder" -ForegroundColor Cyan
    Write-Host "========================================" -ForegroundColor Cyan
    
    # Build paths
    $sourcePath = if ($SourceRootFolder -eq "") { $subFolder } else { "$SourceRootFolder/$subFolder" }
    $destinationPath = if ($DestinationRootFolder -eq "") { $subFolder } else { "$DestinationRootFolder/$subFolder" }
    
    # Ensure root destination folder exists (only for non-dry run)
    if (-not $DryRun) {
        Initialize-AzureFilesDirectory -DirectoryPath $destinationPath -Context $azureContext
    }
    
    # Start recursive processing
    if ($DryRun) {
        Copy-FilesRecursively -SourcePath $sourcePath -DestinationPath $destinationPath -AzureContext $azureContext -DryRun
    } else {
        Copy-FilesRecursively -SourcePath $sourcePath -DestinationPath $destinationPath -AzureContext $azureContext
    }
}

if ($DryRun) {
    # Display summary statistics
    Write-Host "`n========================================" -ForegroundColor Yellow
    Write-Host "DRY RUN SUMMARY" -ForegroundColor Yellow
    Write-Host "========================================" -ForegroundColor Yellow
    Write-Host "Total folders to create: $($script:Stats.FoldersToCreate)" -ForegroundColor Cyan
    Write-Host "Total files to copy: $($script:Stats.FilesToCopy)" -ForegroundColor Cyan
    $totalSizeGB = [math]::Round($script:Stats.TotalSize / 1GB, 2)
    $totalSizeMB = [math]::Round($script:Stats.TotalSize / 1MB, 2)
    Write-Host "Total size to copy: $totalSizeMB MB ($totalSizeGB GB)" -ForegroundColor Cyan
    
    Write-Host "`n--- Folders to be created ---" -ForegroundColor Yellow
    if ($script:Stats.FoldersList.Count -gt 0) {
        $script:Stats.FoldersList | ForEach-Object { Write-Host "  + $_" -ForegroundColor DarkYellow }
    } else {
        Write-Host "  (No new folders needed)" -ForegroundColor Gray
    }
    
    Write-Host "`n--- Files to be copied ---" -ForegroundColor Yellow
    if ($script:Stats.FilesList.Count -gt 0) {
        $script:Stats.FilesList | ForEach-Object { 
            Write-Host "  $($_.Name)" -ForegroundColor White
            Write-Host "    From: $($_.Source)" -ForegroundColor Gray
            Write-Host "    To:   $($_.Destination)" -ForegroundColor Gray
            Write-Host "    Size: $($_.Size) MB" -ForegroundColor Gray
        }
    } else {
        Write-Host "  (No files to copy)" -ForegroundColor Gray
    }
    
    Write-Host "`n========================================" -ForegroundColor Green
    Write-Host "DRY RUN COMPLETED - Ready to execute" -ForegroundColor Green
    Write-Host "Run without -DryRun to perform actual copy" -ForegroundColor Green
    Write-Host "========================================" -ForegroundColor Green
} else {
    # Clean up temp directory
    if (Test-Path $TempDownloadPath) {
        Remove-Item $TempDownloadPath -Recurse -Force -ErrorAction SilentlyContinue
    }
    
    Write-Host "`n========================================" -ForegroundColor Green
    Write-Host "Copy process completed!" -ForegroundColor Green
    Write-Host "========================================" -ForegroundColor Green
} } catch {
Write-Host "Error in main execution: $_" -ForegroundColor Red
Write-Host $_.Exception.Message -ForegroundColor Red } finally {
Disconnect-PnPOnline -ErrorAction SilentlyContinue }
</pre></td></tr></tbody></table></code></div></div>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/azure/">Azure</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/azure/"
            class="post-tag no-text-decoration"
          >azure</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=Copy%20sharepoint%20data%20to%20Azure%20Filez%20-%20BensiEgils&url=https%3A%2F%2Flubenz007.github.io%2F%2Fposts%2Fsharepoint-to-azurefilez%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fab fa-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Copy%20sharepoint%20data%20to%20Azure%20Filez%20-%20BensiEgils&u=https%3A%2F%2Flubenz007.github.io%2F%2Fposts%2Fsharepoint-to-azurefilez%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/sharepoint-to-azurefilez/">Copy sharepoint data to Azure Filez</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/ssh-arc-wac/">Secure Remote Management with Windows Admin Center via Azure Arc and SSH Tunneling.</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/Move-VmWare-Azure/">Migrating from VMware to Azure using Azure Files</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/OutofDiskspace-Teams/">Arc - Diskspace Monitoring - Teams)</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/AzureArc-ssh/">Azure Arc - (Azure Cli - ssh - rdp)</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/azure/">azure</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/msgraph/">msgraph</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/usage/">usage</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hyperv/">hyperv</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/monitor/">monitor</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/powershell/">powershell</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/security/">security</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/terraform/">terraform</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/tools/">tools</a>
      
    </div>
  </section>


            </div>

            
              
              







            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    










  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/AzureUsage/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1683986400"
  data-df="ll"
  
>
  May 13, 2023
</time>

              <h4 class="pt-0 my-2">Monitor Azure usage with github actions</h4>
              <div class="text-muted">
                <p>This will not work for Azure Plan subscriptions. ((400) Subscription scope usage is not supported for current api version. Please use api version after 2019-10-01)   Need to keep track of your Azur...</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/Three-tool/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1683756000"
  data-df="ll"
  
>
  May 10, 2023
</time>

              <h4 class="pt-0 my-2">Three great tools for Azure</h4>
              <div class="text-muted">
                <p>Always in need for some tools to help make great things.          Azure Quick Review Azure Quick Review (azqr) goal is to produce a high level assessment of an Azure Subscription or Resource Group ...</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/azure-cost-cli/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1683144000"
  data-df="ll"
  
>
  May  3, 2023
</time>

              <h4 class="pt-0 my-2">Azure Cost CLI</h4>
              <div class="text-muted">
                <p>Azure-Cost-CLI is a new tool to get cost information from Azure. Link  What are the benefits of this tool?, Simple, you can get cost information from Azure without having to log in to the portal. ?...</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/ssh-arc-wac/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Secure Remote Management with Windows Admin Center via Azure Arc and SSH Tunneling.</p>
    </a>
  

  
    <div class="btn btn-outline-primary disabled" aria-label="Newer">
      <p>-</p>
    </div>
  
</nav>

            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2025</time>

    
      <a href="https://twitter.com/lubenz007">Benedikt Gabriel Egilsson</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.4.1"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/azure/">azure</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/msgraph/">msgraph</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/usage/">usage</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hyperv/">hyperv</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/monitor/">monitor</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/powershell/">powershell</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/security/">security</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/terraform/">terraform</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/tools/">tools</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">Oops! No results found.</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

