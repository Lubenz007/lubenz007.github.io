<!DOCTYPE html>
<html lang="en" dir="auto">

<head>
	<meta name="generator" content="Hugo 0.147.9"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>BensiEgils</title>
<meta name="keywords" content="blog, azure, powershell, automation, security">
<meta name="description" content="Documenting my journey">
<meta name="author" content="Benedikt Gabriel Egilsson">
<link rel="canonical" href="http://localhost:1313/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.2d0325420c619a782224fbdbc50e6417d66f71c30e5607ad7ddb5b0ecce5d6cc.css" integrity="sha256-LQMlQgxhmngiJPvbxQ5kF9ZvccMOVgetfdtbDszl1sw=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" type="application/rss+xml" href="http://localhost:1313/index.xml" title="rss">
<link rel="alternate" type="application/json" href="http://localhost:1313/index.json" title="json">
<link rel="alternate" hreflang="en" href="http://localhost:1313/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://localhost:1313/">
  <meta property="og:site_name" content="BensiEgils">
  <meta property="og:title" content="BensiEgils">
  <meta property="og:description" content="Documenting my journey">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="website">
      <meta property="og:image" content="http://localhost:1313/">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:1313/">
<meta name="twitter:title" content="BensiEgils">
<meta name="twitter:description" content="Documenting my journey">

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "BensiEgils",
  "url": "http://localhost:1313/",
  "description": "Documenting my journey",
  "logo": "http://localhost:1313/favicon.ico",
  "sameAs": [
      "https://twitter.com/lubenz007", "https://github.com/lubenz007", "https://www.linkedin.com/in/benedikt-gabríel-egilsson-b7295684"
  ]
}
</script>
</head>

<body class="list" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="BensiEgils (Alt + H)">BensiEgils</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main"> 

<article class="post-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">Getting old guest accounts in Azure AD
    </h2>
  </header>
  <div class="entry-content">
    <p>This is a rewrite from here office365itpros.com I have added some more properties to the report. And use msgraph instead of mggraph.
# Needs permission User.Read.All $ClientID = &#39;&#39; $ClientSecret = &#39;&#39; $tenant_Id = &#39;&#39; # Connect to Graph # $Body = @{ Grant_Type = &#34;client_credentials&#34; resource = &#34;https://graph.microsoft.com&#34; client_id = $clientId client_secret = $clientSecret } $ConnectGraph = Invoke-RestMethod -Uri &#34;https://login.microsoft.com/$tenant_Id/oauth2/token?api-version=1.0&#34; -Method POST -Body $Body # Variable Collections # $Headers = @{ &#39;Content-Type&#39; = &#34;application/json&#34; &#39;Authorization&#39; = &#34;Bearer $($ConnectGraph.access_token)&#34; } $token = $ConnectGraph.access_token # Force TLS 1.2. [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12 function Get-GraphData { param ( [parameter(Mandatory)] [string]$AccessToken, [parameter(Mandatory)] [string]$Uri ) $Headers = @{ &#39;Authorization&#39; = &#34;Bearer $AccessToken&#34; } do { $Results = Invoke-RestMethod -Uri $Uri -Headers $Headers -ErrorAction Stop $QueryResults &#43;= $Results.value $Uri = $Results.&#39;@odata.nextLink&#39; } while ($Uri) return $QueryResults } #This request get users list with signInActivity. $uri = &#34;https://graph.microsoft.com/beta/users&#34; $Result = @() [array]$Response = Get-GraphData -AccessToken $Token -Uri $uri if ($Response) { ForEach ($Respons in $Response) { $Result &#43;= New-Object PSObject -property $([ordered]@{ DisplayName = $Respons.displayName UserPrincipalName = $Respons.userPrincipalName UsageLocation = $Respons.usageLocation Contry = $Respons.country LastSignInDateTime = if($Respons.signInActivity.lastSignInDateTime) { [DateTime]$Respons.signInActivity.lastSignInDateTime } Else {$null} IsLicensed = if ($Respons.assignedLicenses.Count -ne 0) { $true } else { $false } IsGuestUser = if ($Respons.userType -eq &#39;Guest&#39;) { $true } else { $false } RefreshTokensValidFromDateTime = $Respons.RefreshTokensValidFromDateTime onPremisesDistinguishedName = $Respons.onPremisesDistinguishedName }) } } else { Write-Host &#34;No User data found&#34; } $GuestUsers = $Result | Where-Object{$_.IsGuestUser -eq &#34;TRUE&#34;} $GuestAccountAge = 365 # Value used for guest age comparison. If you want this to be a different value (like 30 days), change this here. #$GuestUsers = $users.value -All $true -Filter &#34;UserType eq &#39;Guest&#39;&#34; | Sort DisplayName $Today = (Get-Date); $StaleGuests = 0 $Report = [System.Collections.Generic.List[Object]]::new() # Check each account and find those over 365 days old ForEach ($Guest in $GuestUsers) { $AADAccountAge = ($Guest.RefreshTokensValidFromDateTime | New-TimeSpan).Days If ($AADAccountAge -gt $GuestAccountAge) { $StaleGuests&#43;&#43; #Write-Host &#34;Processing&#34; $Guest.DisplayName $i = 0; $GroupNames = $Null # Find what Microsoft 365 Groups the guest belongs to... if any $ReportLine = [PSCustomObject]@{ UPN = $Guest.UserPrincipalName Name = $Guest.DisplayName Age = $AADAccountAge Created = $Guest.RefreshTokensValidFromDateTime } $Report.Add($ReportLine) } } # Output the report $Report | Sort Age -Descending | Format-Table -AutoSize Write-Host &#34;Found&#34; $StaleGuests &#34;stale guest accounts.&#34; #reference: https://office365itpros.com/2019/10/15/report-old-guest-accounts/ </p>
  </div>
  <footer class="entry-footer"><span title='2023-04-26 23:00:49 +0000 GMT'>April 26, 2023</span>&nbsp;·&nbsp;<span>2 min</span>&nbsp;·&nbsp;<span>368 words</span>&nbsp;·&nbsp;<span>Benedikt Gabriel Egilsson</span></footer>
  <a class="entry-link" aria-label="post link to Getting old guest accounts in Azure AD" href="http://localhost:1313/posts/2023-04-26-old-guest-accounts/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">Getting started with Terraform and Azure
    </h2>
  </header>
  <div class="entry-content">
    <p>I like to watch videos on how to do things, but i don’t like to start from scratch. I like to have a template from which i can start and test things out. So start to look out for exporting Azure config to templates. Terraformer is a tool that can export existing cloud infrastructure to Terraform code. But I like aztfexport better because it is more Azure-specific.
Install aztfexport is easy from package manager c:\winget install aztfexport And we need also Azure Cli c:\winget install azure-cli Login to Azure This was the part I struggled with: where is the config file? It was too simple: login to Azure with Azure Cli and then select the subscription I wanted to export from. Terraform, Terraformer, and aztfexport will use the same subscription as Azure Cli.
...</p>
  </div>
  <footer class="entry-footer"><span title='2023-04-22 18:46:49 +0000 GMT'>April 22, 2023</span>&nbsp;·&nbsp;<span>2 min</span>&nbsp;·&nbsp;<span>253 words</span>&nbsp;·&nbsp;<span>Benedikt Gabriel Egilsson</span></footer>
  <a class="entry-link" aria-label="post link to Getting started with Terraform and Azure" href="http://localhost:1313/posts/2023-04-22-aztfexport/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">Apps Expiration Azure AD
    </h2>
  </header>
  <div class="entry-content">
    <p>This script will check all registered apps in Azure AD and will return the following information: expiring apps, expired apps, and apps with no expiration date. # needs permission Application.Read.All,Directory.Read.All $ClientID = &#39;&#39; $ClientSecret = &#39;&#39; $tenant_Id = &#39;&#39; $TenantName = $Body = @{ Grant_Type = &#34;client_credentials&#34; resource = &#34;https://graph.microsoft.com&#34; client_id = $clientId client_secret = $clientSecret } $ConnectGraph = Invoke-RestMethod -Uri &#34;https://login.microsoft.com/$tenant_Id/oauth2/token?api-version=1.0&#34; -Method POST -Body $Body # Variable Collections # $path = &#34;C:\temp\&#34; $today = Get-Date $Headers = @{ &#39;Content-Type&#39; = &#34;application/json&#34; &#39;Authorization&#39; = &#34;Bearer $($ConnectGraph.access_token)&#34; } $token = $ConnectGraph.access_token # Force TLS 1.2. [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12 function Get-GraphData { param ( [parameter(Mandatory)] [string]$AccessToken, [parameter(Mandatory)] [string]$Uri ) $Headers = @{ &#39;Authorization&#39; = &#34;Bearer $AccessToken&#34; } do { $Results = Invoke-RestMethod -Uri $Uri -Headers $Headers -ErrorAction Stop $QueryResults &#43;= $Results.value $Uri = $Results.&#39;@odata.nextLink&#39; } while ($Uri) return $QueryResults } #This request get application info $uri = &#34;https://graph.microsoft.com/beta/applications/&#34; [array]$apps = Get-GraphData -AccessToken $Token -Uri $uri $credentials = @() if ($apps) { foreach ($app in $apps) { $ApiUrl = &#34;https://graph.microsoft.com/beta/applications/&#34;&#43;$app.id&#43;&#34;/owners&#34; $owner = Invoke-WebRequest -Method GET -Uri $ApiUrl -ContentType &#34;application/json&#34; -Headers $headers | ConvertFrom-Json $app.KeyCredentials | foreach-object { #write-host $_.KeyId $_.DisplayName $credentials &#43;= [PSCustomObject] @{ CredentialType = &#34;KeyCredentials&#34;; DisplayName = $app.DisplayName; AppId = $app.AppId; ExpiryDate = $_.EndDateTime; StartDate = $_.StartDateTime; #KeyID = $_.KeyId; Type = $_.Type; Usage = $_.Usage; Owners = $owner.value.userPrincipalName; Expired = (([DateTime]$_.EndDateTime) -lt $today) ? &#34;Yes&#34; : &#34;No&#34;; } } $app.PasswordCredentials | foreach-object { #write-host $_.KeyId $_.DisplayName $credentials &#43;= [PSCustomObject] @{ CredentialType = &#34;PasswordCredentials&#34;; DisplayName = $app.DisplayName; AppId = $app.AppId; ExpiryDate = $_.EndDateTime; StartDate = $_.StartDateTime; #KeyID = $_.KeyId; Type = &#39;NA&#39;; Usage = &#39;NA&#39;; Owners = $owner.value.userPrincipalName; Expired = (([DateTime]$_.EndDateTime) -lt $today) ? &#34;Yes&#34; : &#34;No&#34;; } } } } $credentials | Export-Csv -Path $path\credentials.csv -NoTypeInformation #$credentials | Format-Table | Out-String|ForEach-Object {Write-Host $_} reference https://pnp.github.io/script-samples/aad-apps-expired-keys/README.html?tabs=graphps {: .prompt-info }
...</p>
  </div>
  <footer class="entry-footer"><span title='2023-04-07 10:34:00 +0000 GMT'>April 7, 2023</span>&nbsp;·&nbsp;<span>2 min</span>&nbsp;·&nbsp;<span>298 words</span>&nbsp;·&nbsp;<span>Benedikt Gabriel Egilsson</span></footer>
  <a class="entry-link" aria-label="post link to Apps Expiration Azure AD" href="http://localhost:1313/posts/2023-04-07-apps-exp/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">Powershell Speedtest
    </h2>
  </header>
  <div class="entry-content">
    <p>Was having problems with my internet connection and wanted to monitor it. So I rewrote this script to use powershell and store the results in a table storage. The script is using the speedtest cli from https://www.speedtest.net/apps/cli {: .prompt-info }
#$StorageAccountName = &#34;StorageAcount&#34; #$Key = &#34;Storagekey&#34; #$StorageContext = New-AzStorageContext -StorageAccountName $StorageAccountName -StorageAccountKey $Key #$Table = (Get-AzStorageTable -Context $StorageContext | Where-Object {$_.name -eq &#34;Speedtest&#34;}).CloudTable $applocation = &#34;C:\apps\speedtest&#34; $path = &#34;C:\temp\&#34; $SpeedTestResults=@() $SpeedtestObj=@() $i = 0 while ($i -eq 0) { $PartitionKey = &#34;1&#34; $SpeedTestResults = &amp; &#34;$($applocation)\speedtest.exe&#34; --progress=no --format=json $SpeedtestResults = $SpeedTestResults | ConvertFrom-Json $SpeedtestObj &#43;= [PSCustomObject] @{ Time = Get-Date -Format &#34;dd/MM/yyyy HH:mm K&#34; downloadspeed = [math]::Round($SpeedtestResults.download.bandwidth / 1000000 * 8, 2) uploadspeed = [math]::Round($SpeedtestResults.upload.bandwidth / 1000000 * 8, 2) packetloss = ($($SpeedtestResults.packetLoss).ToString(&#34;P&#34;)) isp = $SpeedtestResults.isp ExternalIP = $SpeedtestResults.interface.externalIp InternalIP = $SpeedtestResults.interface.internalIp UsedServer = $SpeedtestResults.server.host location = $SpeedTestResults.server.location Jitter = [math]::Round($SpeedtestResults.ping.jitter) Latency = [math]::Round($SpeedtestResults.ping.latency) } # ---- Move to table storage ---- # Add-AzTableRow -table $Table -PartitionKey $PartitionKey -RowKey (Get-Date).Ticks -property $SpeedtestObj Start-Sleep -Seconds 15 } #$SpeedtestObj | Format-Table | Out-String|ForEach-Object {Write-Host $_} $SpeedtestObj | Export-Csv -Path $path\speedtest.csv -NoTypeInformation </p>
  </div>
  <footer class="entry-footer"><span title='2023-04-06 20:15:00 +0000 GMT'>April 6, 2023</span>&nbsp;·&nbsp;<span>1 min</span>&nbsp;·&nbsp;<span>179 words</span>&nbsp;·&nbsp;<span>Benedikt Gabriel Egilsson</span></footer>
  <a class="entry-link" aria-label="post link to Powershell Speedtest" href="http://localhost:1313/posts/2023-04-06-speedtest/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">Esp32 Hot tub controller
    </h2>
  </header>
  <div class="entry-content">
    <p>This is my hot tub controler with outdoor shower controler. It is based on a ESP32 and a 4 channel relay module. It has a DS18B20 temperature sensor for the hot tub and a DS18B20 for the water in the hot tub. It also has a DS18B20 for the outdoor shower and a DS18B20 for the water in system. esphome: name: pottastyring platform: ESP32 board: nodemcu-32s wifi: ssid: &#34;&#34; password: &#34;&#34; domain: .lan manual_ip: static_ip: 192.168.x.x gateway: 192.168.x.x subnet: 255.255.255.0 dns1: 192.168.x.x # Enable fallback hotspot (captive portal) in case wifi connection fails ap: ssid: &#34;hottub&#34; password: &#34;&#34; captive_portal: web_server: port: 80 # Enable logging logger: # Enable Home Assistant API api: ota: time: - platform: sntp id: timer servers: - 0.pool.ntp.org - 1.pool.ntp.org - 2.pool.ntp.org dallas: - pin: GPIO13 sensor: - platform: dallas address: 0x67011464EA7EFF28 name: &#34;Pottur hiti&#34; id: pottur_hiti - platform: dallas address: 0x8B0314649975FF28 name: &#34;Vatn i pott&#34; id: vatn_i_hiti - platform: dallas address: 0x110000045976f328 name: &#34;Hiti Skapur&#34; id: Hiti_skapur - platform: dallas address: 0xe10314645814ff28 name: &#34;Hiti Uti&#34; id: hiti_uti binary_sensor: - platform: gpio filters: - delayed_on: 100ms id: fylla pin: number: GPIO17 mode: INPUT_PULLUP inverted: True name: &#34;Pottur fylla takki&#34; on_press: if: condition: lambda: &#39;return id(pottur_hiti).state &lt; 20;&#39; then: - logger.log: &#34;The sensor value is below 20!&#34; - switch.turn_on: relay_1 - delay: 1min - switch.turn_on: relay_4 - delay: 30min - switch.turn_off: relay_1 - delay: 3min - climate.control: id: pottur_climate mode: &#34;HEAT&#34; else: - logger.log: &#34;The sensor value is above 20!&#34; - platform: gpio filters: - delayed_on: 500ms id: sturta pin: number: GPIO21 mode: INPUT_PULLUP inverted: True name: &#34;Sturta takki&#34; on_press: if: condition: lambda: &#39;return id(pottur_hiti).state &gt; 38;&#39; then: - logger.log: &#34;The sensor value is above 38!&#34; - climate.control: id: pottur_climate mode: &#34;OFF&#34; - delay: 10sec - switch.turn_on: relay_3 - delay: 4min - switch.turn_off: relay_3 else: - logger.log: &#34;The sensor value is below 20!&#34; - switch.turn_on: relay_3 - delay: 4min - switch.turn_off: relay_3 - platform: gpio filters: - delayed_on: 500ms id: nidurfall pin: number: GPIO33 mode: INPUT_PULLUP inverted: True name: &#34;taema takki&#34; on_press: then: - switch.turn_off: relay_4 - climate.control: id: pottur_climate mode: &#34;off&#34; switch: - platform: gpio restore_mode: ALWAYS_OFF name: &#34;Pottur fylla relay&#34; pin: GPIO25 id: relay_1 - platform: gpio restore_mode: ALWAYS_OFF name: &#34;Pottur hita relay&#34; pin: GPIO26 id: relay_2 - platform: gpio restore_mode: ALWAYS_OFF name: &#34;Sturta relay&#34; pin: GPIO27 id: relay_3 - platform: gpio restore_mode: ALWAYS_ON name: &#34;Loka nidurfalli&#34; pin: GPIO18 id: relay_4 climate: - platform: bang_bang id: pottur_climate visual: min_temperature: 38 max_temperature: 42 temperature_step: 1.0 name: &#34;Pottur vatn&#34; sensor: pottur_hiti default_target_temperature_low: 38 °C default_target_temperature_high: 40 °C heat_action: if: condition: lambda: &#39;return id(pottur_hiti).state &gt; 32;&#39; then: - logger.log: &#34;The sensor is above 32! then full&#34; - switch.turn_on: relay_1 - switch.turn_on: relay_2 else: - logger.log: &#34;The sensor value is below 32!&#34; - switch.turn_on: relay_1 - delay: 1min - switch.turn_on: relay_4 - delay: 30min - switch.turn_on: relay_2 idle_action: - switch.turn_off: relay_2 - switch.turn_off: relay_1 mqtt: broker: 192.168.x.x username: xxx password: xxx </p>
  </div>
  <footer class="entry-footer"><span title='2023-04-04 22:15:00 +0000 GMT'>April 4, 2023</span>&nbsp;·&nbsp;<span>3 min</span>&nbsp;·&nbsp;<span>482 words</span>&nbsp;·&nbsp;<span>Benedikt Gabriel Egilsson</span></footer>
  <a class="entry-link" aria-label="post link to Esp32 Hot tub controller" href="http://localhost:1313/posts/2023-04-04-hottub/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">Upgrade Hyper-V Hosts with Azure Arc
    </h2>
  </header>
  <div class="entry-content">
    <p>Azure Arc is a powerful tool for managing and updating hybrid infrastructure, including standalone Hyper-V hosts. Demo how to use Azure Arc to update a standalone Hyper-V host, using a scheduled update task in Automation Account and pre and post scripts that shut down and start up VMs. Pre-requisites
# Stop all running VMs on the Hyper-V host and wait for them to shut down # save the names of the running VMs to a file $filePath = &#34;C:\temp\runningvm.txt&#34; (Get-vm | Where-Object { $_.State -eq &#34;Running&#34; }).name | Out-File $filePath $runningvm = Get-Content $filePath foreach ($Name in $runningvm) { Stop-VM $Name do { $VM1 = get-vm -Name $Name Write-Progress -Activity &#34;Waiting for the VM to shutdown&#34; } until ($Null -eq $VM1.Heartbeat) } # send a webhook to Teams to notify that the VMs have been shut down $webhookUri = &#34;&#34; $body = @{ &#34;@context&#34; = &#34;http://schema.org/extensions&#34; &#34;@type&#34; = &#34;MessageCard&#34; &#34;themeColor&#34; = &#34;d70000&#34; &#34;title&#34; = &#34;Send Webhook to Teams&#34; &#34;text&#34; = &#34;This is a message sent from Powershell&#34; } Invoke-RestMethod -Uri $webhookUri -Method Post -Body (ConvertTo-Json -InputObject $body) Post-requisites
...</p>
  </div>
  <footer class="entry-footer"><span title='2023-04-04 22:15:00 +0000 GMT'>April 4, 2023</span>&nbsp;·&nbsp;<span>2 min</span>&nbsp;·&nbsp;<span>354 words</span>&nbsp;·&nbsp;<span>Benedikt Gabriel Egilsson</span></footer>
  <a class="entry-link" aria-label="post link to Upgrade Hyper-V Hosts with Azure Arc" href="http://localhost:1313/posts/2023-04-04-upgrade-hyper/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">Getting licenses assigned to user accounts
    </h2>
  </header>
  <div class="entry-content">
    <p>Create a report of licenses assigned to Azure AD user accounts using the Microsoft Graph API This is a rewrite from here practical365.com My misson was to rewrite the script to use the Microsoft Graph API instead of the MgGraph PowerShell module. {: .prompt-info }
$ClientID = &#39;&#39; $ClientSecret = &#39;&#39; $tenant_Id = &#39;&#39; # Connect to Graph # $Body = @{ Grant_Type = &#34;client_credentials&#34; resource = &#34;https://graph.microsoft.com&#34; client_id = $clientId client_secret = $clientSecret } $ConnectGraph = Invoke-RestMethod -Uri &#34;https://login.microsoft.com/$tenant_Id/oauth2/token?api-version=1.0&#34; -Method POST -Body $Body # Variable Collections # $CSVOutputFile = &#34;c:\temp\Microsoft365LicensesReport.CSV&#34; $today = Get-Date $Headers = @{ &#39;Content-Type&#39; = &#34;application/json&#34; &#39;Authorization&#39; = &#34;Bearer $($ConnectGraph.access_token)&#34; } $token = $ConnectGraph.access_token # Force TLS 1.2. [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12 function Get-GraphData { param ( [parameter(Mandatory)] [string]$AccessToken, [parameter(Mandatory)] [string]$Uri ) $Headers = @{ &#39;Authorization&#39; = &#34;Bearer $AccessToken&#34; } do { $Results = Invoke-RestMethod -Uri $Uri -Headers $Headers -ErrorAction Stop $QueryResults &#43;= $Results.value $Uri = $Results.&#39;@odata.nextLink&#39; } while ($Uri) return $QueryResults } #This request get SecureScore [array]$Skus = Get-GraphData -AccessToken $Token -Uri &#34;https://graph.microsoft.com/beta/subscribedSkus&#34; #[Array]$Skus = Get-MgSubscribedSku # Generate CSV of all product SKUs used in tenant [array]$Sku = $Skus | Select-Object SkuId, SkuPartNumber # Generate list of all service plans used in SKUs in tenant $SPData = [System.Collections.Generic.List[Object]]::new() ForEach ($Sk in $Skus) { ForEach ($SP in $Sk.ServicePlans) { $SPLine = [PSCustomObject][Ordered]@{ ServicePlanId = $SP.ServicePlanId ServicePlanName = $SP.ServicePlanName ServicePlanDisplayName = $SP.ServicePlanName } $SPData.Add($SPLine) } } $SkuHashTable = @{} ForEach ($Line in $Sku) { $SkuHashTable.Add([string]$Line.SkuId, [string]$Line.skuPartNumber) } $ServicePlanHashTable = @{} ForEach ($Line2 in $SPData) { $ServicePlanHashTable.Add([string]$Line2.ServicePlanId, [string]$Line2.ServicePlanDisplayName) } [Array]$Users = Get-GraphData -AccessToken $Token -Uri &#34;https://graph.microsoft.com/beta/users&#34; $Report = [System.Collections.Generic.List[Object]]::new() ForEach ($User in $users) { If ([string]::IsNullOrWhiteSpace($User.AssignedLicenses) -eq $true) { # Only process account if it has some licenses Write-Host &#34;Processing&#34; $User.DisplayName [array]$LicenseInfo = $Null; [array]$DisabledPlans = $Null ForEach ($License in $User.AssignedLicenses) { If ($SkuHashTable.ContainsKey($License.SkuId) -eq $True) { # We found a match in the SKU hash table $LicenseInfo &#43;= $SkuHashTable.Item($License.SkuId) } Else { # Nothing doing, so output the SkuID $LicenseInfo &#43;= $License } # Report any disabled service plans in licenses If ([string]::IsNullOrWhiteSpace($License.DisabledPlans) -eq $False ) { # Check if disabled service plans in a license ForEach ($DisabledPlan in $License.DisabledPlans) { # Try and find what service plan is disabled If ($ServicePlanHashTable.ContainsKey($DisabledPlan) -eq $True) { # We found a match in the Service Plans hash table $DisabledPlans &#43;= $ServicePlanHashTable.Item($DisabledPlan) } Else { # Nothing doing, so output the Service Plan ID $DisabledPlans &#43;= $DisabledPlan } } # End ForEach disabled plans } # End if check for disabled plans } # End Foreach Licenses # Report information [string]$DisabledPlans = $DisabledPlans -join &#34;, &#34; [string]$LicenseInfo = $LicenseInfo -join (&#34;, &#34;) $ReportLine = [PSCustomObject][Ordered]@{ User = $User.DisplayName UPN = $User.UserPrincipalName Country = $User.Country Department = $User.Department Title = $User.JobTitle Licenses = $LicenseInfo &#34;Disabled Plans&#34; = $DisabledPlans } Write-Host $ReportLine $Report.Add($ReportLine) } #end If account is licensed Else { $UnlicensedAccounts&#43;&#43; } } # End ForEach Users $Report | Export-CSV -NoTypeInformation $CSVOutputFile </p>
  </div>
  <footer class="entry-footer"><span title='2023-04-01 00:27:00 +0000 GMT'>April 1, 2023</span>&nbsp;·&nbsp;<span>3 min</span>&nbsp;·&nbsp;<span>480 words</span>&nbsp;·&nbsp;<span>Benedikt Gabriel Egilsson</span></footer>
  <a class="entry-link" aria-label="post link to Getting licenses assigned to user accounts" href="http://localhost:1313/posts/2023-01-04-license-report/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">MS Graph API - Get Secure Score for tenant
    </h2>
  </header>
  <div class="entry-content">
    <p>Secure Score for O365 Tenant Getting the secure score for a tenant is a bit more complicated than getting the last logon time of a user. You only need to call the following endpoint: https://graph.microsoft.com/beta/security/secureScores and divide the result by 100 to get the percentage.
# Needs permission SecurityEvents.Read.All $ClientID = &#39;&#39; $ClientSecret = &#39;&#39; $tenant_Id = &#39;&#39; # Connect to Graph # $Body = @{ Grant_Type = &#34;client_credentials&#34; resource = &#34;https://graph.microsoft.com&#34; client_id = $clientId client_secret = $clientSecret } $ConnectGraph = Invoke-RestMethod -Uri &#34;https://login.microsoft.com/$tenant_Id/oauth2/token?api-version=1.0&#34; -Method POST -Body $Body # Variable Collections # $path = &#34;C:\temp\&#34; $Headers = @{ &#39;Content-Type&#39; = &#34;application/json&#34; &#39;Authorization&#39; = &#34;Bearer $($ConnectGraph.access_token)&#34; } $token = $ConnectGraph.access_token # Force TLS 1.2. [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12 function Get-GraphData { param ( [parameter(Mandatory)] [string]$AccessToken, [parameter(Mandatory)] [string]$Uri ) $Headers = @{ &#39;Authorization&#39; = &#34;Bearer $AccessToken&#34; } do { $Results = Invoke-RestMethod -Uri $Uri -Headers $Headers -ErrorAction Stop $QueryResults &#43;= $Results.value $Uri = $Results.&#39;@odata.nextLink&#39; } while ($Uri) return $QueryResults } #This request get SecureScore $uri = &#34;https://graph.microsoft.com/beta/security/secureScores&#34; $Result = @() [array]$Response = Get-GraphData -AccessToken $Token -Uri $uri if ($Response) { ForEach ($Respons in $Response) { $SecureScore = $Respons.currentScore / $Respons.maxScore * 100 $Result &#43;= New-Object PSObject -property $([ordered]@{ CreatedDateTime = $Respons.createdDateTime CurrentScore = $Respons.currentScore MaxScore = $Respons.maxScore LicensedUserCount = $Respons.licensedUserCount ActiveUserCount = $Respons.activeUserCount SecureScore = [math]::Round($SecureScore, 2) }) } } else { Write-Host &#34;No SecureScore data found&#34; } # export to csv $Result | export-csv -path &#34;$path\SecureScore.csv&#34; -NoTypeInformation </p>
  </div>
  <footer class="entry-footer"><span title='2023-03-25 22:49:00 +0000 GMT'>March 25, 2023</span>&nbsp;·&nbsp;<span>2 min</span>&nbsp;·&nbsp;<span>235 words</span>&nbsp;·&nbsp;<span>Benedikt Gabriel Egilsson</span></footer>
  <a class="entry-link" aria-label="post link to MS Graph API - Get Secure Score for tenant" href="http://localhost:1313/posts/2023-03-23-sgraph-securescore/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">Getting Started with MSGraph API
    </h2>
  </header>
  <div class="entry-content">
    <p>Authentication and Authorization MSGraph API is a powerful tool for authentication and authorization that allows developers to access Microsoft services and data. It provides a secure way to authenticate users, authorize applications, and manage user data. With MSGraph API, developers can easily integrate their applications with Microsoft services like Outlook, OneDrive, Office 365, Azure Active Directory, and more. In this article, we’ll explore how to get started with MSGraph API concepts and use cases of the API. Authentication We will use the Azure CLI to create a service principal and get the app id and secret. We will also use the Azure CLI to view all the API permissions available in Microsoft Graph. Get the Azure CLI from here {: .prompt-info }
...</p>
  </div>
  <footer class="entry-footer"><span title='2023-03-25 13:49:00 +0000 GMT'>March 25, 2023</span>&nbsp;·&nbsp;<span>2 min</span>&nbsp;·&nbsp;<span>352 words</span>&nbsp;·&nbsp;<span>Benedikt Gabriel Egilsson</span></footer>
  <a class="entry-link" aria-label="post link to Getting Started with MSGraph API" href="http://localhost:1313/posts/2023-03-23-sgraph-api/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">MS Graph API - Get User info
    </h2>
  </header>
  <div class="entry-content">
    <p>Microsoft Graph API can be used to get the last logon time of a user. To do this, you will need to make a GET request to the /users/{id}/lastLogonTimeStamp endpoint. This endpoint will return the last logon time of the user in the form of a timestamp. You can then use this timestamp to determine the exact date and time of the user’s last logon. This query get’s.
DisplayName,UserPrincipalName,UsageLocation,Contry,LastSignInDateTime,IsLicensed,IsGuestUser {: .prompt-info }
...</p>
  </div>
  <footer class="entry-footer"><span title='2023-03-25 13:49:00 +0000 GMT'>March 25, 2023</span>&nbsp;·&nbsp;<span>2 min</span>&nbsp;·&nbsp;<span>316 words</span>&nbsp;·&nbsp;<span>Benedikt Gabriel Egilsson</span></footer>
  <a class="entry-link" aria-label="post link to MS Graph API - Get User info" href="http://localhost:1313/posts/2023-03-23-sgraph-users/"></a>
</article>
<footer class="page-footer">
  <nav class="pagination">
    <a class="prev" href="http://localhost:1313/">
      «&nbsp;Prev&nbsp;
    </a>
  </nav>
</footer>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">BensiEgils</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
